<% provide(:title, 'My photos') %>
<%= render partial: 'shared/main_nav' %>

<div class="jumbotron jumbotron-fluid mb-0" style="background-color:#E1F5FE">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h1 class="jumbotron-heading h2 text-muted">My photo album</h1>
      </div>
    </div>
  </div>
</div>
<div class="mb-3" style="border-bottom: 1px solid #f3f3f3;">
  <div class="container py-3">
    <div class="row">
      <div class="col-12">
        <ul class="nav nav-pills">
          <li class="nav-item">
            <%= link_to '← Back to profile', user_path(current_user), { class: 'nav-link' } %>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>


<section class="container mb-5">

  <% if flash.notice.present? %>
    <div class="row">
      <div class="offset-md-3 col-md-6">
        <div class="alert alert-info text-center">
          <%= flash.notice %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="row">
    <div class="col-lg-5 push-lg-7 mb-5 pt-1">
      <div class="row">
        <div class="col-12 text-center">
          <%= link_to "Add a photo", '#', class: 'btn btn-lg btn-success', id: 'add-a-photo' %>
        </div>
      </div>
    </div>

    <% if @photos.empty? %>

      <div class="col-lg-7 pull-lg-5">
        <div class="rounded p-5 text-center text-muted" style="border: 2px dashed #ccc">
          <p class="m-lg-5 m-2">Spice up your profile with some photos.</p>
        </div>
      </div>

    <% else %>
      <div class="col-lg-7 pull-lg-5">
        <%= render partial: 'photos/photo', collection: @photos %>
      </div>
    <% end %>

  </div>
</section>

<%= form_for@photo do |f| %>
  <%= f.hidden_field :image, value: @photo.cached_image_data %>
<% end %>

<link href="https://transloadit.edgly.net/releases/uppy/v0.23.3/dist/uppy.min.css" rel="stylesheet">

<script src="https://transloadit.edgly.net/releases/uppy/v0.23.3/dist/uppy.min.js" type="text/javascript"></script>
<script type="text/javascript">
  var albumUploader = Uppy.Core({
    autoProceed: true,
    restrictions: {
      maxFileSize: 5000000,
      maxNumberOfFiles: 1,
      minNumberOfFiles: 1,
      allowedFileTypes: ['image/*']
    }
  });

  albumUploader.use(Uppy.Dashboard, {
    trigger: '#add-a-photo',
    note: "Selfie? Picture with friends and family? We love them all 🎉. You can add a caption later.",
    metaFields: [
      { id: 'caption', name: 'Caption', placeholder: 'eg: Me with my family' }
    ],
    locale: {
      strings: {
        dropPaste: 'Drop your photo here or'
      }
    }
  });

  albumUploader.use(Uppy.AwsS3, {
    getUploadParameters: function(file) {
      return fetch('/presign?filename=' + encodeURIComponent(file.name))
          .then(function (response) {
            return response.json();
          });
    }
  });

  albumUploader.on("upload-success", function (file, data) {
    var uploadedFileData = JSON.stringify({
      id: file.meta['key'].match(/^cache\/(.+)/)[1],
      storage: 'cache'
    });
    $('#new_photo')
      .find('#photo_image')
      .val(uploadedFileData)
      .end()
      .submit();
  });

  albumUploader.run();


</script>
